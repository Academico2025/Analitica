<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Atlas TI Lite PRO – IA + Análisis Cualitativo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- vis-network CDN para red -->
  <script src="https://unpkg.com/vis-network@9.1.9/dist/vis-network.min.js"></script>
  <link href="https://unpkg.com/vis-network@9.1.9/dist/dist/vis-network.min.css" rel="stylesheet"/>
  <style>
    body { font-family: Segoe UI, Arial, sans-serif; background: #f5f6fa; margin:0; color: #232323;}
    header { background: #4c51bf; color: #fff; padding: 1.5rem 1rem; text-align: center;}
    .container { max-width: 1150px; margin: 2rem auto; padding: 2rem; background: #fff; border-radius: 16px; box-shadow: 0 4px 24px #0002;}
    textarea { width: 100%; min-height: 120px; font-size: 1rem; padding: 0.7rem; border-radius: 8px; border: 1px solid #b3b3b3; margin-bottom: 1.2rem;}
    button { background: #4c51bf; color: #fff; border: none; border-radius: 12px; padding: 0.7rem 2.2rem; font-size: 1rem; cursor: pointer;}
    button:hover { background: #434190; }
    .row { display: flex; gap: 1.5rem;}
    .panel { flex: 1; min-width: 270px;}
    .panel-border {border:1px solid #d1d5db; border-radius: 11px; padding: 0.9rem; background:#f7fafc;}
    .cloud { font-size: 1.3rem; line-height: 2.1rem; margin: 12px 0;}
    .cloud span { display: inline-block; margin: 0 6px; cursor:pointer;}
    .chart-bar { display: flex; align-items: center; margin-bottom: 6px;}
    .bar { height: 18px; background: #4c51bf66; margin-left: 10px; border-radius: 10px;}
    .percent { color: #4c51bf; font-weight: bold; margin-left: 8px;}
    .tabla { border-collapse: collapse; width: 100%; margin: 7px 0;}
    .tabla th, .tabla td { border: 1px solid #bbb; padding: 7px 10px; text-align: center;}
    .tabla th { background: #4c51bf; color: #fff;}
    .codetag { font-size: .96em; background: #c7d2fe; padding: 2px 8px; border-radius: 9px; margin-right: 3px; color:#2c5282; cursor:pointer;}
    .codetag.selected, .codetag:hover { background:#4c51bf; color:#fff;}
    .fragment { background: #fff59f; border-radius:3px;}
    #network { width: 100%; height: 230px; border: 1px solid #aaa; border-radius:10px; background: #faf9f5; margin-bottom: 14px;}
    @media (max-width:950px) { .row { flex-direction: column;} .panel{min-width:100px;} #network{height:140px;} }
  </style>
</head>
<body>
  <header>
    <h1>Atlas TI Lite PRO – Cualitativo Interactivo con IA</h1>
    <div>Codifica, interpreta, grafica, explora relaciones y resume con HuggingFace</div>
  </header>
  <div class="container">
    <h2>1. Pega aquí las respuestas de los docentes (una por párrafo o línea)</h2>
    <textarea id="input" placeholder="Pega aquí las respuestas"></textarea>
    <button onclick="analizar()">Interpretar y Graficar</button>
    <div class="row" style="margin-top:2rem;">
      <!-- Panel Izquierdo: Respuestas -->
      <div class="panel panel-border">
        <h3>Respuestas (selecciona texto y asígnale código)</h3>
        <input type="text" id="search" style="width:80%;" placeholder="Buscar..." oninput="buscarEnRespuestas()" />
        <div id="respuestas"></div>
      </div>
      <!-- Panel Central: Codificación y Códigos -->
      <div class="panel panel-border">
        <h3>Códigos manuales</h3>
        <input type="text" id="nuevoCodigo" style="width:66%;" placeholder="Crear nuevo código"/>
        <button onclick="crearCodigo()" style="padding: 0.4rem 1.1rem;">Crear</button>
        <div id="listaCodigos" style="margin:10px 0;"></div>
        <div id="panelCodigos"></div>
      </div>
      <!-- Panel Derecho: Visualización -->
      <div class="panel panel-border">
        <b>Nube de Palabras</b>
        <div id="cloud" class="cloud"></div>
        <b>Frecuencia de Palabras</b>
        <div id="barras"></div>
        <b>Red de Co-ocurrencia (Palabras)</b>
        <div id="network"></div>
        <b>Tabla de palabras</b>
        <table class="tabla" id="tablaPalabras"></table>
      </div>
    </div>
    <div class="panel-border" style="margin-top:2.2rem;">
      <h3>Resumen Automático (IA HuggingFace)</h3>
      <div id="resumen"></div>
    </div>
  </div>
<script>
const STOPWORDS = ["de","la","y","el","en","los","del","que","se","con","por","las","para","es","una","un","al","lo","sus","o","a","como","más","le","su","ha","ya","pero","sí","no","fue","son","han","sobre","entre","también","cuando","muy","sin","hay","todo","nos","esta","me","mi","yo","él","tiene","si","qué","quien","desde","porque","hace","esto","cada","solo","donde","puede","ser","hasta"];
let textosRaw=[], codigos=[], codificaciones={}, selectedCodigo=null, palabrasTop=[], palabrasPorDocente=[];

function analizar() {
  let raw = document.getElementById('input').value.trim();
  if(!raw) return alert("Pega los textos de las encuestas.");
  textosRaw = raw.split(/\n+/).map(t=>t.trim()).filter(t=>t.length>0);

  // Conteo de palabras
  let frecuencias={}, docentesPalabra={};
  palabrasPorDocente = textosRaw.map(txt=>{
    let palabras = txt.replace(/[.,;:!?¿¡()"]/g,"").toLowerCase().split(/\s+/)
      .filter(w=>w.length>2 && !STOPWORDS.includes(w));
    let set = new Set(palabras);
    set.forEach(w=>{
      docentesPalabra[w]=(docentesPalabra[w]||0)+1;
    });
    palabras.forEach(w=>{
      frecuencias[w]=(frecuencias[w]||0)+1;
    });
    return set;
  });
  palabrasTop = Object.entries(frecuencias).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([w])=>w);

  renderRespuestas();
  renderNube(frecuencias);
  renderBarras(docentesPalabra);
  renderTablaPalabras(docentesPalabra, frecuencias);
  renderCodigos();
  renderRedPalabras(docentesPalabra);
  renderResumen(frecuencias,docentesPalabra);
  selectedCodigo = null;
  document.getElementById('search').value='';
}

// ---------------- CODIFICACIÓN MANUAL -----------------
function renderRespuestas() {
  let html='';
  textosRaw.forEach((txt,i)=>{
    let safe = txt.replace(/</g,"&lt;").replace(/>/g,"&gt;");
    html += `<div style="margin-bottom:12px;position:relative;">
      <span style="font-weight:600;color:#4c51bf;">Docente ${i+1}:</span>
      <div style="cursor:text;" onmouseup="codificarFragmento(${i})" id="texto${i}">
        ${resaltarCodigos(safe,i)}
      </div>
    </div>`;
  });
  document.getElementById('respuestas').innerHTML=html;
}

function resaltarCodigos(txt,index){
  if(!codificaciones[index]) return txt;
  let frag = codificaciones[index].sort((a,b)=>b.start-a.start);
  frag.forEach(code=>{
    txt = txt.substring(0,code.start) + `<span class="fragment" title="Código: ${code.codigo}">${txt.substring(code.start,code.end)}</span>` + txt.substring(code.end);
  });
  return txt;
}

function codificarFragmento(i){
  let sel = window.getSelection();
  let tNode = document.getElementById("texto"+i);
  if(!sel.anchorNode || !tNode.contains(sel.anchorNode)) return;
  let text = sel.toString();
  if(!text.trim()) return;
  let code = prompt("Asignar código a: \""+text+"\"\n(Si no existe, se creará)");
  if(!code) return;
  let start = sel.anchorOffset, end = start+text.length;
  let fullText = tNode.innerText||tNode.textContent;
  let idx = fullText.indexOf(text);
  if(idx==-1) idx=start;
  if(!codificaciones[i]) codificaciones[i]=[];
  if(!codigos.includes(code)) codigos.push(code);
  codificaciones[i].push({codigo: code, texto: text, start: idx, end: idx+text.length});
  renderRespuestas();
  renderCodigos();
}

// ----------- PANEL DE CÓDIGOS Y FRAGMENTOS -----------
function crearCodigo(){
  let code = document.getElementById('nuevoCodigo').value.trim();
  if(!code || codigos.includes(code)) return;
  codigos.push(code);
  document.getElementById('nuevoCodigo').value='';
  renderCodigos();
}

function renderCodigos(){
  let html='';
  codigos.forEach(c=>{
    let count=0;
    textosRaw.forEach((txt,i)=>{
      if(codificaciones[i]){
        codificaciones[i].forEach(f=>{
          if(f.codigo==c){count++;}
        });
      }
    });
    html += `<span class="codetag${selectedCodigo==c?' selected':''}" onclick="filtrarPorCodigo('${c}')">${c} (${count})</span>`;
  });
  document.getElementById('listaCodigos').innerHTML=html||"<i>No hay códigos aún</i>";

  let fragshtml='';
  if(selectedCodigo){
    fragshtml += `<b>Fragmentos para <span style="color:#4c51bf">${selectedCodigo}</span>:</b><ul>`;
    textosRaw.forEach((txt,i)=>{
      if(codificaciones[i]){
        codificaciones[i].forEach(f=>{
          if(f.codigo==selectedCodigo)
            fragshtml+=`<li><b>Docente ${i+1}:</b> <span class="fragment">${f.texto}</span></li>`;
        });
      }
    });
    fragshtml+="</ul>";
  }
  document.getElementById('panelCodigos').innerHTML=fragshtml;
}

function filtrarPorCodigo(c){
  selectedCodigo=selectedCodigo==c?null:c;
  renderCodigos();
  renderRespuestas();
}

// ----------- NUBE DE PALABRAS Y BARRAS -----------
function renderNube(frecuencias){
  let html='';
  Object.entries(frecuencias).sort((a,b)=>b[1]-a[1]).slice(0,22).forEach(([w,c],i)=>{
    let size=18+c*3;
    html+=`<span style="font-size:${size}px;color:#${(120+i*10).toString(16)}7${(80+i*12).toString(16)}bf;" onclick="buscarNube('${w}')">${w}</span> `;
  });
  document.getElementById('cloud').innerHTML=html;
}
function renderBarras(docentesPalabra){
  let html='';
  Object.entries(docentesPalabra).sort((a,b)=>b[1]-a[1]).slice(0,12).forEach(([w,c])=>{
    let perc = ((c/textosRaw.length)*100).toFixed(1);
    html += `<div class="chart-bar">
      <span style="width:110px;display:inline-block;">${w}</span>
      <div class="bar" style="width:${c*16+20}px"></div>
      <span class="percent">${perc}% docentes</span>
    </div>`;
  });
  document.getElementById('barras').innerHTML=html;
}

// ----------- TABLA DE PALABRAS -----------
function renderTablaPalabras(docentesPalabra, frecuencias){
  let table = `<tr><th>Palabra</th><th>Frecuencia</th><th>% Docentes</th></tr>`;
  Object.entries(docentesPalabra).sort((a,b)=>b[1]-a[1]).slice(0,10).forEach(([w,c])=>{
    let perc = ((c/textosRaw.length)*100).toFixed(1);
    table += `<tr><td><span style="font-weight:600">${w}</span></td><td>${frecuencias[w]||c}</td><td>${perc}%</td></tr>`;
  });
  document.getElementById('tablaPalabras').innerHTML = table;
}

// ----------- RED DE CO-OCURRENCIA DE PALABRAS -----------
function renderRedPalabras(docentesPalabra){
  let pares = {}, nodos={}, edges=[];
  palabrasTop.forEach(w=>nodos[w]=true);
  palabrasPorDocente.forEach(set=>{
    palabrasTop.forEach(w1=>{
      if(set.has(w1)){
        palabrasTop.forEach(w2=>{
          if(w2!==w1 && set.has(w2)){
            let key = [w1,w2].sort().join('-');
            pares[key] = (pares[key]||0)+1;
          }
        });
      }
    });
  });
  let nodes = palabrasTop.map((w,i)=>({
    id: w, label: w, value: (docentesPalabra[w]||1), color: "#4c51bf"
  }));
  Object.entries(pares).forEach(([key,val])=>{
    if(val>1){
      let [w1,w2] = key.split('-');
      edges.push({from:w1, to:w2, width: 1+val, color: {color:'#90cdf4'}});
    }
  });
  let container = document.getElementById('network');
  container.innerHTML = '';
  if(nodes.length>1){
    new vis.Network(container, {nodes:new vis.DataSet(nodes), edges:new vis.DataSet(edges)}, {
      nodes: {shape:'dot', size:22, font:{size:16, color:'#434190'}},
      edges: {smooth:{type:'dynamic'}, color:{color:'#ddd'}, width:2, selectionWidth:4},
      physics: {stabilization: true, barnesHut: {springConstant: 0.08}},
      interaction: {hover:true}
    });
  }
}

// ----------- RESUMEN AUTOMÁTICO (HuggingFace) -----------
async function renderResumen(frecuencias,docentesPalabra){
  let palabrasFrecuentes = Object.entries(frecuencias).sort((a,b)=>b[1]-a[1]);
  let interpretacion = '';
  interpretacion += `Se analizaron <b>${textosRaw.length}</b> respuestas.<br>`;
  interpretacion += `Palabras más frecuentes: <b>${palabrasFrecuentes.slice(0,4).map(([w])=>w).join(', ')}</b>.<br>`;
  
  try {
    const HF_TOKEN = "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";  // 👈 pega tu token aquí
    const HF_MODEL = "sshleifer/distilbart-cnn-12-6";

    const rawText = textosRaw.join(" ");
    const response = await fetch(`https://api-inference.huggingface.co/models/${HF_MODEL}`, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${HF_TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        inputs: rawText.slice(0, 2000) // límite en versión free
      })
    });

    if(!response.ok){
      throw new Error("Error en API: " + response.status);
    }

    const data = await response.json();
    if(data && data[0] && data[0].summary_text){
      interpretacion += `<br><b>Resumen automático (IA):</b> ${data[0].summary_text}`;
    } else {
      interpretacion += `<br><b>Resumen automático:</b> No se pudo generar.`;
    }
  } catch(err){
    console.error(err);
    interpretacion += `<br><b>Error al generar resumen:</b> ${err.message}`;
  }

  document.getElementById('resumen').innerHTML = interpretacion;
}

// ----------- BÚSQUEDA Y RESALTADO EN RESPUESTAS -----------
function buscarNube(palabra){
  document.getElementById('search').value = palabra;
  buscarEnRespuestas();
}

function buscarEnRespuestas() {
  let q = document.getElementById('search').value.trim().toLowerCase();
  let html='';
  textosRaw.forEach((txt,i)=>{
    let safe = txt.replace(/</g,"&lt;").replace(/>/g,"&gt;");
    if(q && safe.toLowerCase().includes(q)){
      let regex = new RegExp("("+q+")","gi");
      safe = safe.replace(regex,'<mark>$1</mark>');
    }
    html += `<div style="margin-bottom:12px;"><b>Docente ${i+1}:</b><div>${safe}</div></div>`;
  });
  if(!q) renderRespuestas(); else document.getElementById('respuestas').innerHTML=html;
}
</script>
</body>
</html>

